# Read dir and file name
sDir <- file.path(dir_data,'reduceSvrid')
tDir <- file.path(dir_data,'divideSvrid')
fileName <- list.files(sDir)
fileName <- fileName[!grepl('g',fileName)]
fn <- 'b10.Rda'
load(file.path(sDir,fn))
fn <- 'f1.Rda'
load(file.path(sDir,fn))
i <- which(names(data) == '4910')
a <- mean_svrid(data[[i]])
#!/usr/bin/env python2
# -*- coding: utf-8 -*-
# Filename: divideFault.R
#
# Description: divide data of fault server into normal part and fault part
#
# Copyright (c) 2016, Yusheng Yi <yiyusheng.hust@gmail.com>
#
# Version 1.0
#
# Initial created: 2016-09-13 15:18:21
#
# Last   modified: 2016-09-13 15:19:09
rm(list = ls())
source('head.R')
####################################
# Read dir and file name
sDir <- file.path(dir_data,'reduceSvrid')
tDir <- file.path(dir_data,'divideSvrid')
fileName <- list.files(sDir)
fileName <- fileName[!grepl('g',fileName)]
# Load failure record
load(file.path(dir_data,'failRecord_diskParse.Rda'))
frecord <- rbind(failRecordWithDev[,c('svr_id','f_time')],
failRecordWithoutDev[,c('svr_id','f_time')])
#determine range
range_det <- function(df,fr){
days <- 60
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(fr,
data.frame(svr_id = '0',f_time = minT),
data.frame(svr_id = '0',f_time = maxT))
fr <- fr[order(fr$f_time),]
fr$t2 <- fr$f_time - 60*86400
fr$t1 <- fr$f_time - 90*86400
fr$t3 <- fr$f_time + 30*86400
lenFr <- nrow(fr)
# fault range
fr$effective <- as.numeric(difftime(fr$t2,minT,units = 'days')) > -30
rangeFau <- subset(fr,svr_id != '0' & effective == T,c('t2','f_time'))
names(rangeFau) <- c('start','end')
if(nrow(rangeFau) == 0)rangeFau <- data.frame()
# normal range
fr$numReserve <- 0
tmp <- as.numeric(difftime(fr$t1[2:lenFr],fr$t3[1:(lenFr-1)],units = 'days'))/days
fr$numReserve[1:(lenFr - 1)] <- floor(tmp)
fr$numReserve[lenFr - 1] <- floor(as.numeric(difftime(fr$t3[lenFr],fr$t3[lenFr - 1]),units = 'days')/days)
tmp <- subset(fr,numReserve != 0)
rangeNor <- list()
if(nrow(tmp) > 0){
for (i in 1:nrow(tmp)){
tmp1 <- data.frame(start = tmp$t3[i] + 0:(tmp$numReserve[i]-1) * days * 86400)
tmp1$end <- tmp1$start + days*86400
rangeNor[[i]] <- tmp1
}
rangeNor <- do.call(rbind,rangeNor)
}else{
rangeNor <- data.frame()
}
list(rangeFau,rangeNor)
}
# process for each svrid
divide_svrid <- function(df,fn){
cat(sprintf('[divideFault::divide_svrid]\tfileName: %s\tsvrid:%s\tcount:%d\tlength:%d\n',
fn,df$svr_id[1],nrow(df),ncol(df)))
curSvr <- as.character(df$svr_id[1])
fr <- subset(frecord,svr_id == curSvr)
lenFr <- nrow(fr)
# Divide data by time.
# data generate in two month before failure are used as fault data.
# data generate three months ahead of failure or one months after failure are used as normal data.
# duration of data longer than one month indicates an effective data for fault and normal data
tmp <- range_det(df,fr)
rangeFau <- tmp[[1]]
rangeNor <- tmp[[2]]
# list[rangeFau,rangeNor] <- range_det(df,fr)
# Generate data
dataF <- list()
if(nrow(rangeFau) >= 1){
for (i in 1:nrow(rangeFau)){
tmp <- subset(df,time > rangeFau$start[i] & time <= rangeFau$end[i])
if(nrow(tmp) == 0) {
dataF[[i]] <- 0
next
}
tmp$svr_id <- paste(tmp$svr_id,'F',i,sep='')
dataF[[i]] <- tmp
}
}
dataN <- list()
if(nrow(rangeNor) >= 1){
for (i in 1:nrow(rangeNor)){
tmp <- subset(df,time > rangeNor$start[i] & time <= rangeNor$end[i])
if(nrow(tmp) == 0) {
dataN[[i]] <- 0
next
}
tmp$svr_id <- paste(tmp$svr_id,'N',i,sep='')
dataN[[i]] <- tmp
}
}
list(dataF,dataN)
}
fn <- 'f1.Rda'
load(file.path(sDir,fn))
i <- which(names(data) == '4910')
a <- divide_svrid(data[[i]],fn)
i
debugSource('~/Code/R/tencProcess/divideFault.R')
View(fr)
debugSource('~/Code/R/tencProcess/divideFault.R')
View(fr)
fr
View(fr)
fr <- fr[order(fr$f_time),]
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(fr,
data.frame(svr_id = '0',f_time = minT),
data.frame(svr_id = '0',f_time = maxT))
fr <- fr[order(fr$f_time),]
minT <- min(fr$time);maxT <- max(fr$time)
days <- 60
fr <- fr[order(fr$f_time),]
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(fr,
data.frame(svr_id = '0',f_time = minT),
data.frame(svr_id = '0',f_time = maxT))
View(fr)
days <- 60
fr <- fr[order(fr$f_time),]
minT <- min(df$time);maxT <- max(df$time)
debugSource('~/Code/R/tencProcess/divideFault.R')
debugSource('~/Code/R/tencProcess/divideFault.R')
View(fr)
fr <- frx[order(frx$f_time),]
df <- dfx
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(data.frame(svr_id = '0',f_time = minT),
fr,
data.frame(svr_id = '0',f_time = maxT))
View(fr)
days <- 60
fr <- frx[order(frx$f_time),]
df <- dfx
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(data.frame(svr_id = '0',f_time = minT),
fr,
data.frame(svr_id = '0',f_time = maxT))
fr$t2 <- fr$f_time - 60*86400
fr$t1 <- fr$f_time - 90*86400
fr$t3 <- fr$f_time + 30*86400
lenFr <- nrow(fr)
# fault range
fr$effective <- as.numeric(difftime(fr$t2,minT,units = 'days')) > -30
rangeFau <- subset(fr,svr_id != '0' & effective == T,c('t2','f_time'))
debugSource('~/Code/R/tencProcess/divideFault.R')
View(fr)
View(rangeFau)
lenFr <- nrow(fr)
View(fr)
days <- 60
fr <- frx[order(frx$f_time),]
df <- dfx
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(data.frame(svr_id = '0',f_time = minT),
fr,
data.frame(svr_id = '0',f_time = maxT))
fr$t2 <- fr$f_time - 60*86400
fr$t1 <- fr$f_time - 90*86400
fr$t3 <- fr$f_time + 30*86400
lenFr <- nrow(fr)
# fault range
fr$effective <- as.numeric(difftime(fr$t2,minT,units = 'days')) > -30
rangeFau <- subset(fr,svr_id != '0' & effective == T,c('t2','f_time'))
names(rangeFau) <- c('start','end')
if(nrow(rangeFau) == 0)rangeFau <- data.frame()
View(fr)
View(rangeFau)
View(rangeFau)
# normal range
fr$numReserve <- 0
tmp <- as.numeric(difftime(fr$t1[2:lenFr],fr$t3[1:(lenFr-1)],units = 'days'))/days
fr$numReserve[1:(lenFr - 1)] <- floor(tmp)
View(fr)
days <- 60
fr <- frx[order(frx$f_time),]
df <- dfx
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(data.frame(svr_id = '0',f_time = minT),
fr,
data.frame(svr_id = '0',f_time = maxT))
fr$t2 <- fr$f_time - 60*86400
fr$t1 <- fr$f_time - 90*86400
fr$t3 <- fr$f_time + 30*86400
lenFr <- nrow(fr)
fr <- fr[,c('svr_id','t1','t2','f_time','t3')]
# fault range
fr$effective <- as.numeric(difftime(fr$t2,minT,units = 'days')) > -30
rangeFau <- subset(fr,svr_id != '0' & effective == T,c('t2','f_time'))
names(rangeFau) <- c('start','end')
if(nrow(rangeFau) == 0)rangeFau <- data.frame()
# normal range
fr$numReserve <- 0
tmp <- as.numeric(difftime(fr$t1[2:lenFr],fr$t3[1:(lenFr-1)],units = 'days'))/days
fr$numReserve[1:(lenFr - 1)] <- floor(tmp)
fr$numReserve[lenFr - 1] <- floor(as.numeric(difftime(fr$t3[lenFr],fr$t3[lenFr - 1]),units = 'days')/days)
days <- 60
fr <- frx[order(frx$f_time),]
df <- dfx
minT <- min(df$time);maxT <- max(df$time)
fr <- rbind(data.frame(svr_id = '0',f_time = minT),
fr,
data.frame(svr_id = '0',f_time = maxT))
fr$t2 <- fr$f_time - 60*86400
fr$t1 <- fr$f_time - 90*86400
fr$t3 <- fr$f_time + 30*86400
lenFr <- nrow(fr)
fr <- fr[,c('svr_id','t1','t2','f_time','t3')]
# fault range
fr$effective <- as.numeric(difftime(fr$t2,minT,units = 'days')) > -30
rangeFau <- subset(fr,svr_id != '0' & effective == T,c('t2','f_time'))
names(rangeFau) <- c('start','end')
if(nrow(rangeFau) == 0)rangeFau <- data.frame()
View(fr)
fr$numReserve <- 0
tmp <- as.numeric(difftime(fr$t1[2:lenFr],fr$t3[1:(lenFr-1)],units = 'days'))/days
fr$numReserve[1:(lenFr - 1)] <- floor(tmp)
fr$numReserve[lenFr - 1] <- floor(as.numeric(difftime(fr$t3[lenFr],fr$t3[lenFr - 1]),units = 'days')/days)
View(fr)
tmp <- subset(fr,numReserve > 0)
rangeNor <- list()
if(nrow(tmp) > 0){
for (i in 1:nrow(tmp)){
tmp1 <- data.frame(start = tmp$t3[i] + 0:(tmp$numReserve[i]-1) * days * 86400)
tmp1$end <- tmp1$start + days*86400
rangeNor[[i]] <- tmp1
}
rangeNor <- do.call(rbind,rangeNor)
}else{
rangeNor <- data.frame()
}
debugSource('~/Code/R/tencProcess/divideFault.R')
tmp <- range_det(df,fr)
tmp <- range_det(df,fr)
debugSource('~/Code/R/tencProcess/divideFault.R')
debugSource('~/Code/R/tencProcess/divideFault.R')
divide_data('d48.Rda')
debugSource('~/Code/R/tencProcess/divideFault.R')
View(rangeNor)
View(rangeFau)
debugSource('~/Code/R/tencProcess/divideFault.R')
View(fr)
a <- subset(frecord,svr_id == curSvr)
debugSource('~/Code/R/tencProcess/divideFault.R')
debugSource('~/Code/R/tencProcess/divideFault.R')
a <- dataN[[1]]
View(a)
summary(a$time)
View(fr)
View(rangeNor)
View(rangeFau)
View(fr)
debugSource('~/Code/R/tencProcess/divideFault.R')
debugSource('~/Code/R/tencProcess/divideFault.R')
View(fr)
fr$t1[lenFr] <- fr$t3[lenFr]
tmp <- as.numeric(difftime(fr$t1[2:lenFr],fr$t3[1:(lenFr-1)],units = 'days'))/days
fr$numReserve[1:(lenFr - 1)] <- floor(tmp)
View(fr)
# fr$numReserve[lenFr - 1] <- floor(as.numeric(difftime(fr$t3[lenFr],fr$t3[lenFr - 1]),units = 'days')/days)
tmp <- subset(fr,numReserve > 0)
View(tmp)
i=1
tmp$numReserve[i]-1
tmp$numReserve[i]
tmp <- as.numeric(difftime(fr$t1[2:lenFr],fr$t3[1:(lenFr-1)],units = 'days'))/days
tmp
fr$numReserve[1:(lenFr - 1)] <- floor(tmp)
# fr$numReserve[lenFr - 1] <- floor(as.numeric(difftime(fr$t3[lenFr],fr$t3[lenFr - 1]),units = 'days')/days)
tmp <- subset(fr,numReserve > 0)
View(tmp)
rangeNor <- list()
if(nrow(tmp) > 0){
for (i in 1:nrow(tmp)){
tmp1 <- data.frame(start = tmp$t3[i] + 0:(tmp$numReserve[i]-1) * days * 86400)
tmp1$end <- tmp1$start + days*86400
rangeNor[[i]] <- tmp1
}
rangeNor <- do.call(rbind,rangeNor)
}else{
rangeNor <- data.frame()
}
debugSource('~/Code/R/tencProcess/divideFault.R')
debugSource('~/Code/R/tencProcess/divideFault.R')
View(rangeNor)
debugSource('~/Code/R/tencProcess/divideFault.R')
View(rangeNor)
View(rangeFau)
View(tmp)
tmp <- subset(fr,numReserve > 0)
rangeNor <- list()
nrow(tmp)
i=1
tmp1 <- data.frame(start = tmp$t3[i] + 0:(tmp$numReserve[i]-1) * days * 86400)
tmp1$end <- min(tmp1$start + days*86400,maxT)
maxT
View(fr)
debugSource('~/Code/R/tencProcess/divideFault.R')
debugSource('~/Code/R/tencProcess/divideFault.R')
a <- dataF[[1]]
View(a)
View(fr)
summary(a$time)
lapply(data,function(x)max(x$time))
debugSource('~/Code/R/tencProcess/divideFault.R')
a <- lapply(dataF,function(x)max(x$time))
unlist(a)
a
View(fr)
source('~/Code/R/tencProcess/divideFault.R')
a <- divide_data('d48.Rda')
debugSource('~/Code/R/tencProcess/divideFault.R')
df <- data[[2]]
df <- data[[2]]
fn <- 'd48.Rda'
load(file.path(sDir,fn))
df <- data[[2]]
curSvr <- as.character(df$svr_id[1])
fr <- subset(frecord,svr_id == curSvr)
fr <- dedupTime(fr,30,'svr_id')
source('~/Code/R/tencProcess/divideFault.R')
source('~/Code/R/tencProcess/mean_als.R')
source('~/Code/R/tencProcess/mean_als.R')
View(mean_ftr)
summary(mead_ftr$mon_id)
table(mean_ftr$mon_id)
a <- subset(mean_ftr,grepl('N',mon_id))
View(a)
df <- mean_ftr;attr <- 'a902';div <- 2^seq(1,10,1)
div
summary(mean_ftr$a902
)
df <- mean_ftr;attr <- 'a902';div <- 2^seq(1,16,1)
s^16
2^16
source('~/Code/R/tencProcess/mean_als.R')
df <- mean_ftr;attr <- 'a902',div <- 2^seq(1,15)
df <- mean_ftr;attr <- 'a902';div <- 2^seq(1,15)
tmp <- df[[attr]]
tmpCut <- cut(tmp,div,include.lowest = T)
if(ori == T){
tmpCut <- gsub('\\[|\\(|,.*','',tmpCut)
}
ori = T
if(ori == T){
tmpCut <- gsub('\\[|\\(|,.*','',tmpCut)
}
tmp <- df[[attr]]
tmpCut <- cut(tmp,div,include.lowest = T)
if(ori == T){
tmpCut <- as.numeric(gsub('\\[|\\(|,.*','',tmpCut))
}
cutNum[[paste(attr,'Cut',sep='')]] <- tmpCut
paste(attr,'Cut',sep='')
df[[paste(attr,'Cut',sep='')]] <- tmpCut
View(df)
tmp <- df[[attr]]
tmpCut <- cut(tmp,div,include.lowest = T)
df[[paste(attr,'Cut',sep='')]] <- tmpCut
div
div <- c(0,2^seq(0,15))
tmp <- df[[attr]]
tmpCut <- cut(tmp,div,include.lowest = T)
if(ori == T){
tmpCut <- as.numeric(gsub('\\[|\\(|,.*','',tmpCut))
}
df[[paste(attr,'Cut',sep='')]] <- tmpCut
View(df)
div
tmp <- df[[attr]]
tmpCut <- cut(tmp,div,include.lowest = T)
df[[paste(attr,'Cut',sep='')]] <- tmpCut
View(df)
tmpCut[7]
as.character(tmpCut[7])
tmp <- df[[attr]]
tmpCut <- cut(tmp,div,include.lowest = T,dig.lab = 10)
if(ori == T){
tmpCut <- as.numeric(gsub('\\[|\\(|,.*','',tmpCut))
}
df[[paste(attr,'Cut',sep='')]] <- tmpCut
source('~/Code/R/tencProcess/mean_als.R')
summary(mean_ftr)
mean_ftr$a902cut <- cutNum(mean_ftr,'a902')
mean_ftr$a903cut <- cutNum(mean_ftr,'a903')
mean_ftr$a999cut <- cutNum(mean_ftr,'a999')
mean_ftr$a3681cut <- cutNum(mean_ftr,'a3681cut')
source('~/Code/R/tencProcess/mean_als.R')
View(mean_ftr)
quantileX(mean_ftr$a902)
quantile(mean_ftr$a902)
quantile(mean_ftr$a902,seq(0,1,0.1))
source('~/Code/R/tencProcess/mean_als.R')
source('~/Code/R/tencProcess/mean_als.R')
View(mean_ftr)
quantile(mean_ftr$a3681,seq(0,1,0.1))
f <- mean_ftr[grepl('F',mean_ftr$mon_id),]
n <- mean_ftr[grepl('N',mean_ftr$mon_id),]
source('~/Code/R/R_Function/Rfun.R')
expandN <- smp_df(n,20,T)
source('~/Code/R/tencProcess/mean_alsFunc.R')
source('~/Code/R/tencProcess/mean_alsFunc.R')
View(svrInfo0902)
frA902 <- calcRate(allData,fData,'a902cut')
attr <- 'a902cut'
diskCount = 1
t1 <- melt(table(allData[,attr]))
fData <- mean_ftr[grepl('F',mean_ftr$mon_id),]
nData <- mean_ftr[grepl('N',mean_ftr$mon_id),]
expandN <- smp_df(n,20,T)
allData <- rbind(fData,nData)
frA902 <- calcRate(allData,fData,'a902cut')
t1 <- melt(table(allData[,attr]))
t2 <- melt(table(fData[,attr]))
View(t1)
View(t2)
View(t1)
tMerge <- merge(t1,t2,by = 'Var1',all = T)
View(tMerge)
names(tMerge) <- c(attr,'count','fCount')
tMerge$AFR <- tMerge$fCount/tMerge$count/diskCount*100
tMerge <- subset(tMerge,!is.na(AFR))
View(tMerge)
allData <- rbind(fData,expandN)
frA902 <- calcRate(allData,fData,'a902cut')
t1 <- melt(table(allData[,attr]))
t2 <- melt(table(fData[,attr]))
tMerge <- merge(t1,t2,by = 'Var1',all = T)
names(tMerge) <- c(attr,'count','fCount')
tMerge$AFR <- tMerge$fCount/tMerge$count/diskCount*100
tMerge <- subset(tMerge,!is.na(AFR))
frA902 <- calcRate(allData,fData,'a902cut')
source('~/Code/R/tencProcess/mean_alsFunc.R')
frA902 <- calcRate(allData,fData,'a902cut')
View(frA902)
frA902 <- calcRate(allData,fData,'a902cut')
frA903 <- calcRate(allData,fData,'a903cut')
frA999 <- calcRate(allData,fData,'a999cut')
frA3681 <- calcRate(allData,fData,'a3681cut')
frA3686 <- calcRate(allData,fData,'a3686cut')
frA3680 <- calcRate(allData,fData,'a3680cut')
View(frA903)
View(frA999)
View(frA3680)
View(frA3681)
View(frA3686)
View(mean_ftr)
summary(mean_ftr$a902)
tmp <- mean_ftr[,c('a902','a3681')]
tmp <- tmp[order(tmp$a902),]
View(tmp)
ggplot(mean_ftr,aes(x = a902, y = a3681)) + geom_point()
quantileX(mean_ftr$a902)
quantile(mean_ftr$a902,sep(0,1,0.1))
quantile(mean_ftr$a902,seq(0,1,0.1))
ggplot(mean_ftr,aes(x = a902, y = a3681)) + geom_point() + scale_x_log10()
mean_ftr$a9023 <- mean_ftr$a902 + mean_ftr$a903
p_read <- sca_plot('a902','a3681')
sca_plot <- function(attr1,attr2){
eval(parse(text = sprintf('p <- ggplot(mean_ftr,aes(x = log2(%s), y = log2(%s))) + geom_point()',attr1,attr2)))
print(p)
p
}
p_read <- sca_plot('a902','a3681')
p_read <- sca_plot(smp_df(mean_ftr,0.1),'a902','a3681')
sca_plot <- function(mean_ftr,attr1,attr2){
eval(parse(text = sprintf('p <- ggplot(mean_ftr,aes(x = log2(%s), y = log2(%s))) + geom_point()',attr1,attr2)))
print(p)
p
}
p_read <- sca_plot(smp_df(mean_ftr,0.1),'a902','a3681')
p_write <- sca_plot('a903','a3685')
p_write <- sca_plot(smp_df(mean_ftr,0.1),'a903','a3685')
p_write <- sca_plot(smp_df(mean_ftr,0.1),'a903','a3686')
p_amount <- sca_plot(smp_df(mean_ftr,0.1),'a9023','a3680')
p_read <- sca_plot(smp_df(mean_ftr,0.1),'a902','a3681')
rate_iopsread_maxiopsread <- mean_ftr[,c('a3681','a3682')]
rate_iopsread_maxiopsread <- mean_ftr[,c('a3681','a3682')]
rate_iopsread_maxiopsread$rate <- rate_iopsread_maxiopsread$a3682/rate_iopsread_maxiopsread$a3681
p_readrate <- ggplot(rate_iopsread_maxiopsread,aes(x = log2(a3681),y = rate)) + geom_point()
print(p_readrate)
rate_iopsread_maxiopsread <- mean_ftr[,c('a3681','a3682')]
rate_iopsread_maxiopsread$rate <- rate_iopsread_maxiopsread$a3682/rate_iopsread_maxiopsread$a3681
p_readrate <- ggplot(rate_iopsread_maxiopsread,aes(x = a3681,y = rate)) + geom_point()
print(p_readrate)
p_readrate <- ggplot(smp_df(rate_iopsread_maxiopsread,0.1),aes(x = a3681,y = rate)) + geom_point()
print(p_readrate)
quantileX(rate_iopsread_maxiopsread$rate)
1/12
plot(quantileX(rate_iopsread_maxiopsread$rate))
source('~/Code/R/attrid/sc16F3.R')
